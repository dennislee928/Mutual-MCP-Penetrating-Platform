# Terraform Makefile
# ç°¡åŒ– Terraform å‘½ä»¤åŸ·è¡Œ

.PHONY: help init plan apply destroy fmt validate clean test

# é è¨­ç’°å¢ƒ
ENV ?= production

# é¡è‰²è¼¸å‡º
GREEN  := $(shell tput -Txterm setaf 2)
YELLOW := $(shell tput -Txterm setaf 3)
CYAN   := $(shell tput -Txterm setaf 6)
RESET  := $(shell tput -Txterm sgr0)

help: ## é¡¯ç¤ºæ­¤å¹«åŠ©è¨Šæ¯
	@echo '${CYAN}Terraform ç®¡ç†å·¥å…·${RESET}'
	@echo ''
	@echo 'ä½¿ç”¨æ–¹å¼:'
	@echo '  ${YELLOW}make${RESET} ${GREEN}<target>${RESET} ${YELLOW}[ENV=<environment>]${RESET}'
	@echo ''
	@echo 'ç›®æ¨™:'
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  ${GREEN}%-20s${RESET} %s\n", $$1, $$2}'
	@echo ''
	@echo 'ç’°å¢ƒ:'
	@echo '  ${YELLOW}dev${RESET}         é–‹ç™¼ç’°å¢ƒ'
	@echo '  ${YELLOW}staging${RESET}     æ¸¬è©¦ç’°å¢ƒ'
	@echo '  ${YELLOW}production${RESET}  ç”Ÿç”¢ç’°å¢ƒ (é è¨­)'
	@echo ''
	@echo 'ç¯„ä¾‹:'
	@echo '  ${CYAN}make init${RESET}              # åˆå§‹åŒ– production ç’°å¢ƒ'
	@echo '  ${CYAN}make plan ENV=dev${RESET}     # æŸ¥çœ‹ dev ç’°å¢ƒçš„åŸ·è¡Œè¨ˆç•«'
	@echo '  ${CYAN}make apply ENV=staging${RESET} # éƒ¨ç½²åˆ° staging ç’°å¢ƒ'

init: ## åˆå§‹åŒ– Terraform
	@echo "${CYAN}ğŸ”§ åˆå§‹åŒ– Terraform (ç’°å¢ƒ: ${ENV})...${RESET}"
	@if [ "${ENV}" = "production" ] || [ "${ENV}" = "dev" ]; then \
		cd environments/${ENV} && terraform init; \
	else \
		terraform init; \
	fi
	@echo "${GREEN}âœ… åˆå§‹åŒ–å®Œæˆ${RESET}"

plan: ## æŸ¥çœ‹åŸ·è¡Œè¨ˆç•«
	@echo "${CYAN}ğŸ“‹ ç”ŸæˆåŸ·è¡Œè¨ˆç•« (ç’°å¢ƒ: ${ENV})...${RESET}"
	@if [ "${ENV}" = "production" ] || [ "${ENV}" = "dev" ]; then \
		cd environments/${ENV} && terraform plan; \
	else \
		terraform plan; \
	fi

apply: ## åŸ·è¡Œéƒ¨ç½²
	@echo "${CYAN}ğŸš€ åŸ·è¡Œéƒ¨ç½² (ç’°å¢ƒ: ${ENV})...${RESET}"
	@echo "${YELLOW}âš ï¸  ç¢ºèªè¦éƒ¨ç½²åˆ° ${ENV} ç’°å¢ƒå—ï¼Ÿ${RESET}"
	@if [ "${ENV}" = "production" ] || [ "${ENV}" = "dev" ]; then \
		cd environments/${ENV} && terraform apply; \
	else \
		terraform apply; \
	fi
	@echo "${GREEN}âœ… éƒ¨ç½²å®Œæˆ${RESET}"

apply-auto: ## è‡ªå‹•åŸ·è¡Œéƒ¨ç½²ï¼ˆç„¡éœ€ç¢ºèªï¼‰
	@echo "${CYAN}ğŸš€ è‡ªå‹•åŸ·è¡Œéƒ¨ç½² (ç’°å¢ƒ: ${ENV})...${RESET}"
	@if [ "${ENV}" = "production" ] || [ "${ENV}" = "dev" ]; then \
		cd environments/${ENV} && terraform apply -auto-approve; \
	else \
		terraform apply -auto-approve; \
	fi
	@echo "${GREEN}âœ… éƒ¨ç½²å®Œæˆ${RESET}"

destroy: ## éŠ·æ¯€è³‡æº
	@echo "${YELLOW}âš ï¸  ç¢ºèªè¦éŠ·æ¯€ ${ENV} ç’°å¢ƒçš„è³‡æºå—ï¼Ÿ${RESET}"
	@if [ "${ENV}" = "production" ] || [ "${ENV}" = "dev" ]; then \
		cd environments/${ENV} && terraform destroy; \
	else \
		terraform destroy; \
	fi

fmt: ## æ ¼å¼åŒ– Terraform æª”æ¡ˆ
	@echo "${CYAN}ğŸ“ æ ¼å¼åŒ– Terraform æª”æ¡ˆ...${RESET}"
	@terraform fmt -recursive
	@echo "${GREEN}âœ… æ ¼å¼åŒ–å®Œæˆ${RESET}"

validate: ## é©—è­‰é…ç½®
	@echo "${CYAN}ğŸ” é©—è­‰ Terraform é…ç½®...${RESET}"
	@if [ "${ENV}" = "production" ] || [ "${ENV}" = "dev" ]; then \
		cd environments/${ENV} && terraform validate; \
	else \
		terraform validate; \
	fi
	@echo "${GREEN}âœ… é©—è­‰é€šé${RESET}"

clean: ## æ¸…ç†è‡¨æ™‚æª”æ¡ˆ
	@echo "${CYAN}ğŸ§¹ æ¸…ç†è‡¨æ™‚æª”æ¡ˆ...${RESET}"
	@find . -type d -name ".terraform" -exec rm -rf {} + 2>/dev/null || true
	@find . -type f -name "*.tfstate*" -delete 2>/dev/null || true
	@find . -type f -name ".terraform.lock.hcl" -delete 2>/dev/null || true
	@echo "${GREEN}âœ… æ¸…ç†å®Œæˆ${RESET}"

test: init validate ## åŸ·è¡Œæ¸¬è©¦ï¼ˆåˆå§‹åŒ– + é©—è­‰ + è¨ˆç•«ï¼‰
	@echo "${CYAN}ğŸ§ª åŸ·è¡Œæ¸¬è©¦...${RESET}"
	@$(MAKE) plan ENV=${ENV}
	@echo "${GREEN}âœ… æ¸¬è©¦å®Œæˆ${RESET}"

output: ## é¡¯ç¤ºè¼¸å‡º
	@echo "${CYAN}ğŸ“Š é¡¯ç¤ºè¼¸å‡º (ç’°å¢ƒ: ${ENV})...${RESET}"
	@if [ "${ENV}" = "production" ] || [ "${ENV}" = "dev" ]; then \
		cd environments/${ENV} && terraform output; \
	else \
		terraform output; \
	fi

health-check: ## åŸ·è¡Œå¥åº·æª¢æŸ¥
	@echo "${CYAN}ğŸ¥ åŸ·è¡Œå¥åº·æª¢æŸ¥ (ç’°å¢ƒ: ${ENV})...${RESET}"
	@if [ "${ENV}" = "production" ] || [ "${ENV}" = "dev" ]; then \
		cd environments/${ENV} && \
		WORKER_URL=$$(terraform output -raw hexstrike_worker_url 2>/dev/null) && \
		if [ -n "$$WORKER_URL" ]; then \
			echo "Testing: $$WORKER_URL/health" && \
			curl -f "$$WORKER_URL/health" || echo "Health check failed"; \
		else \
			echo "Worker URL not found"; \
		fi; \
	fi

# ç’°å¢ƒç‰¹å®šå¿«æ·å‘½ä»¤
dev-init: ## åˆå§‹åŒ– dev ç’°å¢ƒ
	@$(MAKE) init ENV=dev

dev-plan: ## dev ç’°å¢ƒåŸ·è¡Œè¨ˆç•«
	@$(MAKE) plan ENV=dev

dev-apply: ## éƒ¨ç½²åˆ° dev ç’°å¢ƒ
	@$(MAKE) apply ENV=dev

prod-init: ## åˆå§‹åŒ– production ç’°å¢ƒ
	@$(MAKE) init ENV=production

prod-plan: ## production ç’°å¢ƒåŸ·è¡Œè¨ˆç•«
	@$(MAKE) plan ENV=production

prod-apply: ## éƒ¨ç½²åˆ° production ç’°å¢ƒ
	@$(MAKE) apply ENV=production

