# Cloudflare Workers è‡ªå‹•éƒ¨ç½²
# ç•¶ PR åˆä½µåˆ° main branch æ™‚è‡ªå‹•éƒ¨ç½²æ‰€æœ‰ Workers

name: Cloudflare Workers Deploy

on:
  push:
    branches:
      - main
    paths:
      - 'infrastructure/cloud-configs/cloudflare/**'
      - 'infrastructure/terraform/**'
      - '.github/workflows/cloudflare-deploy.yml'
  pull_request:
    branches:
      - main
    types: [closed]
  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'éƒ¨ç½²ç›®æ¨™'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - hexstrike
          - backend
          - ai
          - d1-only

env:
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

jobs:
  # åƒ…åœ¨ PR åˆä½µåˆ° main æˆ–ç›´æ¥ push åˆ° main æ™‚åŸ·è¡Œ
  check-deployment:
    name: æª¢æŸ¥éƒ¨ç½²æ¢ä»¶
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    steps:
      - name: æª¢æŸ¥æ˜¯å¦æ‡‰è©²éƒ¨ç½²
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… Push to main - å°‡åŸ·è¡Œéƒ¨ç½²"
          elif [[ "${{ github.event_name }}" == "pull_request" && "${{ github.event.pull_request.merged }}" == "true" ]]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… PR å·²åˆä½µåˆ° main - å°‡åŸ·è¡Œéƒ¨ç½²"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… æ‰‹å‹•è§¸ç™¼ - å°‡åŸ·è¡Œéƒ¨ç½²"
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  ä¸ç¬¦åˆéƒ¨ç½²æ¢ä»¶ - è·³é"
          fi

  # D1 è³‡æ–™åº«éƒ¨ç½²
  deploy-d1:
    name: éƒ¨ç½² D1 è³‡æ–™åº«
    runs-on: ubuntu-latest
    needs: check-deployment
    if: needs.check-deployment.outputs.should_deploy == 'true' && (github.event.inputs.deploy_target == 'all' || github.event.inputs.deploy_target == 'd1-only' || github.event.inputs.deploy_target == '')
    steps:
      - name: Checkout ä»£ç¢¼
        uses: actions/checkout@v4

      - name: è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: å®‰è£ Wrangler CLI
        run: npm install -g wrangler@latest

      - name: æª¢æŸ¥ D1 è³‡æ–™åº«æ˜¯å¦å­˜åœ¨
        id: check_db
        continue-on-error: true
        run: |
          DB_EXISTS=$(wrangler d1 list | grep "security-platform-db" || echo "not_found")
          if [[ "$DB_EXISTS" == "not_found" ]]; then
            echo "db_exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  è³‡æ–™åº«ä¸å­˜åœ¨ï¼Œå°‡å‰µå»ºæ–°è³‡æ–™åº«"
          else
            echo "db_exists=true" >> $GITHUB_OUTPUT
            echo "âœ… è³‡æ–™åº«å·²å­˜åœ¨"
          fi

      - name: å‰µå»º D1 è³‡æ–™åº«
        if: steps.check_db.outputs.db_exists == 'false'
        run: |
          wrangler d1 create security-platform-db

      - name: ç²å–è³‡æ–™åº« ID
        id: get_db_id
        run: |
          DB_ID=$(wrangler d1 list | grep "security-platform-db" | awk '{print $2}')
          echo "db_id=$DB_ID" >> $GITHUB_OUTPUT
          echo "ğŸ“Š è³‡æ–™åº« ID: $DB_ID"

      - name: åŸ·è¡Œ Schema åˆå§‹åŒ–
        run: |
          cd infrastructure/terraform
          wrangler d1 execute security-platform-db \
            --file=d1-schema.sql \
            --remote || echo "âš ï¸ Schema å¯èƒ½å·²å­˜åœ¨"

      - name: é©—è­‰è³‡æ–™åº«
        run: |
          wrangler d1 execute security-platform-db \
            --command "SELECT name FROM sqlite_master WHERE type='table'" \
            --remote

  # Backend Worker éƒ¨ç½²
  deploy-backend:
    name: éƒ¨ç½² Backend Worker
    runs-on: ubuntu-latest
    needs: [check-deployment, deploy-d1]
    if: needs.check-deployment.outputs.should_deploy == 'true' && (github.event.inputs.deploy_target == 'all' || github.event.inputs.deploy_target == 'backend' || github.event.inputs.deploy_target == '')
    steps:
      - name: Checkout ä»£ç¢¼
        uses: actions/checkout@v4

      - name: è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: å®‰è£ Wrangler CLI
        run: npm install -g wrangler@latest

      - name: ç²å– D1 è³‡æ–™åº« ID
        id: get_db_id
        run: |
          DB_ID=$(wrangler d1 list | grep "security-platform-db" | awk '{print $2}')
          echo "db_id=$DB_ID" >> $GITHUB_OUTPUT
          echo "ğŸ“Š è³‡æ–™åº« ID: $DB_ID"

      - name: æ›´æ–° wrangler é…ç½®
        run: |
          cd infrastructure/cloud-configs/cloudflare
          sed -i "s/database_id = \".*\"/database_id = \"${{ steps.get_db_id.outputs.db_id }}\"/" wrangler-backend.toml

      - name: éƒ¨ç½² Backend Worker
        run: |
          cd infrastructure/cloud-configs/cloudflare
          wrangler deploy --config wrangler-backend.toml

      - name: é©—è­‰éƒ¨ç½²
        run: |
          echo "â³ ç­‰å¾… Worker å•Ÿå‹•..."
          sleep 10
          WORKER_URL=$(wrangler deployments list --name unified-backend | grep -o 'https://[^[:space:]]*' | head -1)
          if [ -n "$WORKER_URL" ]; then
            echo "âœ… Backend Worker URL: $WORKER_URL"
            curl -f "$WORKER_URL/health" || echo "âš ï¸  Health check å¤±æ•—"
          fi

  # AI Worker éƒ¨ç½²
  deploy-ai:
    name: éƒ¨ç½² AI Worker
    runs-on: ubuntu-latest
    needs: [check-deployment, deploy-d1]
    if: needs.check-deployment.outputs.should_deploy == 'true' && (github.event.inputs.deploy_target == 'all' || github.event.inputs.deploy_target == 'ai' || github.event.inputs.deploy_target == '')
    steps:
      - name: Checkout ä»£ç¢¼
        uses: actions/checkout@v4

      - name: è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: å®‰è£ Wrangler CLI
        run: npm install -g wrangler@latest

      - name: ç²å– D1 è³‡æ–™åº« ID
        id: get_db_id
        run: |
          DB_ID=$(wrangler d1 list | grep "security-platform-db" | awk '{print $2}')
          echo "db_id=$DB_ID" >> $GITHUB_OUTPUT
          echo "ğŸ“Š è³‡æ–™åº« ID: $DB_ID"

      - name: æ›´æ–° wrangler é…ç½®
        run: |
          cd infrastructure/cloud-configs/cloudflare
          sed -i "s/database_id = \".*\"/database_id = \"${{ steps.get_db_id.outputs.db_id }}\"/" wrangler-ai.toml

      - name: éƒ¨ç½² AI Worker
        run: |
          cd infrastructure/cloud-configs/cloudflare
          wrangler deploy --config wrangler-ai.toml

      - name: é©—è­‰éƒ¨ç½²
        run: |
          echo "â³ ç­‰å¾… Worker å•Ÿå‹•..."
          sleep 10
          WORKER_URL=$(wrangler deployments list --name unified-ai-quantum | grep -o 'https://[^[:space:]]*' | head -1)
          if [ -n "$WORKER_URL" ]; then
            echo "âœ… AI Worker URL: $WORKER_URL"
            curl -f "$WORKER_URL/health" || echo "âš ï¸  Health check å¤±æ•—"
          fi

  # HexStrike Worker éƒ¨ç½²
  deploy-hexstrike:
    name: éƒ¨ç½² HexStrike Worker
    runs-on: ubuntu-latest
    needs: [check-deployment, deploy-d1]
    if: needs.check-deployment.outputs.should_deploy == 'true' && (github.event.inputs.deploy_target == 'all' || github.event.inputs.deploy_target == 'hexstrike' || github.event.inputs.deploy_target == '')
    steps:
      - name: Checkout ä»£ç¢¼
        uses: actions/checkout@v4

      - name: è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: å®‰è£ Wrangler CLI
        run: npm install -g wrangler@latest

      - name: éƒ¨ç½² HexStrike Worker
        run: |
          cd infrastructure/cloud-configs/cloudflare
          wrangler deploy --config wrangler-hexstrike.toml

      - name: é©—è­‰éƒ¨ç½²
        run: |
          echo "â³ ç­‰å¾… Worker å•Ÿå‹•..."
          sleep 10
          WORKER_URL=$(wrangler deployments list --name unified-hexstrike | grep -o 'https://[^[:space:]]*' | head -1)
          if [ -n "$WORKER_URL" ]; then
            echo "âœ… HexStrike Worker URL: $WORKER_URL"
            curl -f "$WORKER_URL/health" || echo "âš ï¸  Health check å¤±æ•—"
          fi

  # éƒ¨ç½²å®Œæˆé€šçŸ¥
  deployment-summary:
    name: éƒ¨ç½²æ‘˜è¦
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-ai, deploy-hexstrike]
    if: always() && needs.check-deployment.outputs.should_deploy == 'true'
    steps:
      - name: Checkout ä»£ç¢¼
        uses: actions/checkout@v4

      - name: è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: å®‰è£ Wrangler CLI
        run: npm install -g wrangler@latest

      - name: ç”Ÿæˆéƒ¨ç½²æ‘˜è¦
        run: |
          echo "## ğŸš€ Cloudflare Workers éƒ¨ç½²æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### éƒ¨ç½²ç‹€æ…‹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Backend
          if [[ "${{ needs.deploy-backend.result }}" == "success" ]]; then
            echo "âœ… Backend Worker - éƒ¨ç½²æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            BACKEND_URL=$(wrangler deployments list --name unified-backend 2>/dev/null | grep -o 'https://[^[:space:]]*' | head -1 || echo "N/A")
            echo "   - URL: $BACKEND_URL" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Backend Worker - éƒ¨ç½²å¤±æ•—æˆ–è·³é" >> $GITHUB_STEP_SUMMARY
          fi
          
          # AI
          if [[ "${{ needs.deploy-ai.result }}" == "success" ]]; then
            echo "âœ… AI Worker - éƒ¨ç½²æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            AI_URL=$(wrangler deployments list --name unified-ai-quantum 2>/dev/null | grep -o 'https://[^[:space:]]*' | head -1 || echo "N/A")
            echo "   - URL: $AI_URL" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ AI Worker - éƒ¨ç½²å¤±æ•—æˆ–è·³é" >> $GITHUB_STEP_SUMMARY
          fi
          
          # HexStrike
          if [[ "${{ needs.deploy-hexstrike.result }}" == "success" ]]; then
            echo "âœ… HexStrike Worker - éƒ¨ç½²æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            HEXSTRIKE_URL=$(wrangler deployments list --name unified-hexstrike 2>/dev/null | grep -o 'https://[^[:space:]]*' | head -1 || echo "N/A")
            echo "   - URL: $HEXSTRIKE_URL" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ HexStrike Worker - éƒ¨ç½²å¤±æ•—æˆ–è·³é" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### å¿«é€Ÿé€£çµ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [Cloudflare Dashboard](https://dash.cloudflare.com/${{ env.CLOUDFLARE_ACCOUNT_ID }}/workers)" >> $GITHUB_STEP_SUMMARY
          echo "- [Backend Dashboard](https://unified-backend.dennisleehappy.org/dashboard)" >> $GITHUB_STEP_SUMMARY
          echo "- [AI Dashboard](https://unified-ai-quantum.dennisleehappy.org/dashboard)" >> $GITHUB_STEP_SUMMARY
          echo "- [HexStrike Dashboard](https://hexstrike-self.dennisleehappy.org/dashboard)" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### å¾ŒçºŒæ­¥é©Ÿ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. è¨ªå• Dashboards ç¢ºèªéƒ¨ç½²ç‹€æ…‹" >> $GITHUB_STEP_SUMMARY
          echo "2. åŸ·è¡Œå®Œæ•´æ¸¬è©¦ï¼š\`bash test-all-workers.sh\`" >> $GITHUB_STEP_SUMMARY
          echo "3. æŸ¥çœ‹å¯¦æ™‚æ—¥èªŒï¼š\`wrangler tail <worker-name>\`" >> $GITHUB_STEP_SUMMARY

      - name: éƒ¨ç½²å®Œæˆé€šçŸ¥
        run: |
          echo "ğŸ‰ éƒ¨ç½²æµç¨‹å®Œæˆï¼"
          echo "ğŸ“Š æŸ¥çœ‹è©³ç´°æ‘˜è¦ï¼šhttps://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

