.PHONY: help build run test clean migrate-up migrate-down swagger lint

# é è¨­ç›®æ¨™
.DEFAULT_GOAL := help

# è®Šæ•¸å®šç¾©
BINARY_NAME=security-platform
MAIN_PATH=./cmd/server
MIGRATION_PATH=./database/migrations

## help: é¡¯ç¤ºå¹«åŠ©è³‡è¨Š
help:
	@echo "å¯ç”¨æŒ‡ä»¤ï¼š"
	@echo "  make build          - å»ºç½®æ‡‰ç”¨ç¨‹å¼"
	@echo "  make run            - åŸ·è¡Œæ‡‰ç”¨ç¨‹å¼"
	@echo "  make dev            - é–‹ç™¼æ¨¡å¼åŸ·è¡Œï¼ˆhot reloadï¼‰"
	@echo "  make test           - åŸ·è¡Œæ¸¬è©¦"
	@echo "  make test-coverage  - åŸ·è¡Œæ¸¬è©¦ä¸¦ç”¢ç”Ÿè¦†è“‹ç‡å ±å‘Š"
	@echo "  make lint           - åŸ·è¡Œç¨‹å¼ç¢¼æª¢æŸ¥"
	@echo "  make clean          - æ¸…ç†å»ºç½®æª”æ¡ˆ"
	@echo "  make deps           - å®‰è£ä¾è³´"
	@echo "  make migrate-up     - åŸ·è¡Œè³‡æ–™åº«é·ç§»ï¼ˆå‡ç´šï¼‰"
	@echo "  make migrate-down   - åŸ·è¡Œè³‡æ–™åº«é·ç§»ï¼ˆé™ç´šï¼‰"
	@echo "  make swagger        - ç”¢ç”Ÿ Swagger æ–‡ä»¶"
	@echo "  make docker-build   - å»ºç½® Docker æ˜ åƒ"
	@echo "  make docker-run     - åŸ·è¡Œ Docker å®¹å™¨"

## deps: å®‰è£ä¾è³´
deps:
	@echo "ğŸ“¦ å®‰è£ Go ä¾è³´..."
	go mod download
	go mod tidy

## build: å»ºç½®æ‡‰ç”¨ç¨‹å¼
build: deps
	@echo "ğŸ”¨ å»ºç½®æ‡‰ç”¨ç¨‹å¼..."
	go build -o bin/$(BINARY_NAME) $(MAIN_PATH)/main.go

## run: åŸ·è¡Œæ‡‰ç”¨ç¨‹å¼
run: build
	@echo "ğŸš€ å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼..."
	./bin/$(BINARY_NAME)

## dev: é–‹ç™¼æ¨¡å¼åŸ·è¡Œ
dev:
	@echo "ğŸ”§ é–‹ç™¼æ¨¡å¼å•Ÿå‹•ï¼ˆä½¿ç”¨ airï¼‰..."
	@if command -v air > /dev/null; then \
		air; \
	else \
		echo "âš ï¸  æœªå®‰è£ airï¼Œè«‹åŸ·è¡Œ: go install github.com/cosmtrek/air@latest"; \
		go run $(MAIN_PATH)/main.go; \
	fi

## test: åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦
test:
	@echo "ğŸ§ª åŸ·è¡Œæ¸¬è©¦..."
	go test -v ./...

## test-coverage: åŸ·è¡Œæ¸¬è©¦ä¸¦ç”¢ç”Ÿè¦†è“‹ç‡å ±å‘Š
test-coverage:
	@echo "ğŸ“Š åŸ·è¡Œæ¸¬è©¦ä¸¦ç”¢ç”Ÿè¦†è“‹ç‡..."
	go test -v -coverprofile=coverage.out ./...
	go tool cover -html=coverage.out -o coverage.html
	@echo "âœ… è¦†è“‹ç‡å ±å‘Šå·²ç”¢ç”Ÿ: coverage.html"

## lint: åŸ·è¡Œç¨‹å¼ç¢¼æª¢æŸ¥
lint:
	@echo "ğŸ” åŸ·è¡Œç¨‹å¼ç¢¼æª¢æŸ¥..."
	@if command -v golangci-lint > /dev/null; then \
		golangci-lint run; \
	else \
		echo "âš ï¸  æœªå®‰è£ golangci-lintï¼Œè«‹åŸ·è¡Œ: go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest"; \
		go vet ./...; \
	fi

## clean: æ¸…ç†å»ºç½®æª”æ¡ˆ
clean:
	@echo "ğŸ§¹ æ¸…ç†å»ºç½®æª”æ¡ˆ..."
	rm -rf bin/
	rm -f coverage.out coverage.html

## migrate-up: åŸ·è¡Œè³‡æ–™åº«é·ç§»ï¼ˆå‡ç´šï¼‰
migrate-up:
	@echo "â¬†ï¸  åŸ·è¡Œè³‡æ–™åº«é·ç§»..."
	@if command -v migrate > /dev/null; then \
		migrate -path $(MIGRATION_PATH) -database "$${DATABASE_URL}" up; \
	else \
		echo "âš ï¸  æœªå®‰è£ migrateï¼Œè«‹åŸ·è¡Œ: go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest"; \
	fi

## migrate-down: åŸ·è¡Œè³‡æ–™åº«é·ç§»ï¼ˆé™ç´šï¼‰
migrate-down:
	@echo "â¬‡ï¸  å›æ»¾è³‡æ–™åº«é·ç§»..."
	@if command -v migrate > /dev/null; then \
		migrate -path $(MIGRATION_PATH) -database "$${DATABASE_URL}" down; \
	else \
		echo "âš ï¸  æœªå®‰è£ migrate"; \
	fi

## migrate-create: å»ºç«‹æ–°çš„é·ç§»æª”æ¡ˆ
migrate-create:
	@read -p "è¼¸å…¥é·ç§»æª”æ¡ˆåç¨±: " name; \
	migrate create -ext sql -dir $(MIGRATION_PATH) -seq $$name

## swagger: ç”¢ç”Ÿ Swagger æ–‡ä»¶
swagger:
	@echo "ğŸ“– ç”¢ç”Ÿ Swagger æ–‡ä»¶..."
	@if command -v swag > /dev/null; then \
		swag init -g $(MAIN_PATH)/main.go -o ./docs; \
	else \
		echo "âš ï¸  æœªå®‰è£ swagï¼Œè«‹åŸ·è¡Œ: go install github.com/swaggo/swag/cmd/swag@latest"; \
	fi

## docker-build: å»ºç½® Docker æ˜ åƒ
docker-build:
	@echo "ğŸ³ å»ºç½® Docker æ˜ åƒ..."
	docker build -t unified-security-platform-backend:latest -f Dockerfile .

## docker-run: åŸ·è¡Œ Docker å®¹å™¨
docker-run:
	@echo "ğŸ³ å•Ÿå‹• Docker å®¹å™¨..."
	docker run -p 3001:3001 --env-file .env unified-security-platform-backend:latest

## format: æ ¼å¼åŒ–ç¨‹å¼ç¢¼
format:
	@echo "ğŸ’… æ ¼å¼åŒ–ç¨‹å¼ç¢¼..."
	go fmt ./...
	@if command -v goimports > /dev/null; then \
		goimports -w .; \
	fi

## mod-update: æ›´æ–°æ‰€æœ‰ä¾è³´åˆ°æœ€æ–°ç‰ˆæœ¬
mod-update:
	@echo "ğŸ”„ æ›´æ–°ä¾è³´..."
	go get -u ./...
	go mod tidy



